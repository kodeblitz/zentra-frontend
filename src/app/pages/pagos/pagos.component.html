<p-toast />
<p-toolbar styleClass="mb-4">
    <ng-template #start>
        <p-button label="Registrar pago" icon="pi pi-plus" severity="secondary" (onClick)="openNew()" />
    </ng-template>
</p-toolbar>

<div class="grid grid-cols-1 gap-4 mb-4">
    <p-card>
        <ng-template #title>
            <span class="flex align-items-center gap-2">
                <i class="pi pi-search"></i>
                Buscar cliente
            </span>
        </ng-template>
        <ng-template #content>
            <p class="text-color-secondary text-sm mb-3">Ingrese nombre, código o RUC (mín. 2 caracteres). Si escribe solo números (RUC), se buscará por RUC.</p>
            <p-autocomplete
                [(ngModel)]="selectedCliente"
                [suggestions]="clientesSugeridos"
                (completeMethod)="buscarClientes($event)"
                (onSelect)="onClienteSelect()"
                (onClear)="pendientes = null; pago.cliente = undefined; documentosConSaldo = []; cuotasPendientes = []"
                optionLabel="razonSocial"
                placeholder="Nombre, código o RUC del cliente"
                styleClass="w-full"
                [dropdown]="false"
                [showClear]="true"
                [minLength]="2"
                inputStyleClass="w-full"
            />
        </ng-template>
    </p-card>
</div>

@if (loadingPendientes()) {
    <p-card>
        <ng-template #content>
            <div class="flex align-items-center gap-2 p-4">
                <i class="pi pi-spin pi-spinner"></i>
                <span>Cargando pendientes del cliente...</span>
            </div>
        </ng-template>
    </p-card>
} @else if (selectedCliente && pendientes) {
    @if (!tienePendientes()) {
        <p-card>
            <ng-template #content>
                <div class="flex align-items-center gap-2 p-4 text-color-secondary">
                    <i class="pi pi-check-circle"></i>
                    <span>Este cliente no tiene documentos ni cuotas pendientes de pago.</span>
                </div>
            </ng-template>
        </p-card>
    } @else {
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 mb-4">
            @if (pendientes.documentos && pendientes.documentos.length > 0) {
                <p-card>
                    <ng-template #title>
                        <span class="flex align-items-center gap-2">
                            <i class="pi pi-file-edit"></i>
                            Documentos con saldo
                        </span>
                    </ng-template>
                    <ng-template #content>
                        <p-table [value]="pendientes.documentos" [tableStyle]="{ 'min-width': '28rem' }" styleClass="p-datatable-sm">
                            <ng-template #header>
                                <tr>
                                    <th>Número</th>
                                    <th>Vencimiento</th>
                                    <th>Total</th>
                                    <th>Saldo</th>
                                    <th>Días venc.</th>
                                    <th></th>
                                </tr>
                            </ng-template>
                            <ng-template #body let-doc>
                                <tr>
                                    <td>{{ doc.numero }}</td>
                                    <td>{{ doc.fechaVencimiento | date:'dd/MM/yyyy' }}</td>
                                    <td>{{ doc.total | number:'1.0-0' }} Gs.</td>
                                    <td>{{ doc.saldoPendiente | number:'1.0-0' }} Gs.</td>
                                    <td>
                                        @if (doc.diasVencido > 0) {
                                            <p-tag [value]="doc.diasVencido + ' días'" severity="warning" />
                                        } @else {
                                            <span class="text-color-secondary">—</span>
                                        }
                                    </td>
                                    <td>
                                        <p-button icon="pi pi-wallet" label="Pagar" [rounded]="true" [text]="true" size="small" (onClick)="openPagarDocumento(doc)" />
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </ng-template>
                </p-card>
            }

            @if (pendientes.creditos && pendientes.creditos.length > 0) {
                <p-card>
                    <ng-template #title>
                        <span class="flex align-items-center gap-2">
                            <i class="pi pi-credit-card"></i>
                            Créditos con cuotas pendientes
                        </span>
                    </ng-template>
                    <ng-template #content>
                        <div class="flex flex-col gap-4">
                            @for (cr of pendientes.creditos; track cr.creditoId) {
                                <div class="surface-50 border-round p-3">
                                    <div class="flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                                        <div class="flex align-items-center gap-2">
                                            <span class="font-semibold">Crédito {{ cr.creditoId }}</span>
                                            <p-tag [value]="cr.estado" [severity]="estadoCreditoTag(cr.estado)" />
                                            <span class="text-color-secondary text-sm">Monto total: {{ cr.montoTotal | number:'1.2-2' }} Gs.</span>
                                        </div>
                                        <div class="flex gap-2">
                                            <p-button icon="pi pi-wallet" label="Pagar cuota" [rounded]="true" [outlined]="true" size="small" (onClick)="openPagarCuotas(cr)" />
                                            <p-button icon="pi pi-times-circle" label="Cancelar préstamo" severity="secondary" [rounded]="true" [outlined]="true" size="small" (onClick)="openCancelarPrestamo(cr)" />
                                        </div>
                                    </div>
                                    <div class="surface-100 border-round p-2 mb-2">
                                        <span class="text-sm font-medium">Capital pendiente (saldo deudor): </span>
                                        <span class="font-semibold">{{ cr.cancelacionAnticipada.montoTotal | number:'1.2-2' }} Gs.</span>
                                    </div>
                                    <p-table [value]="cr.cancelacionAnticipada.desglose" [tableStyle]="{ 'min-width': '32rem' }" styleClass="p-datatable-sm p-datatable-gridlines">
                                        <ng-template #header>
                                            <tr>
                                                <th>Cuota</th>
                                                <th>Vencimiento</th>
                                                <th>Monto cuota</th>
                                                <th>Mora</th>
                                                <th>A pagar</th>
                                                <th></th>
                                            </tr>
                                        </ng-template>
                                        <ng-template #body let-cu>
                                            <tr>
                                                <td>
                                                    {{ cu.nroCuota }}
                                                    @if (cu.adelantada) {
                                                        <p-tag value="Adelantada" severity="info" styleClass="ml-1" />
                                                    }
                                                </td>
                                                <td>{{ cu.fechaVencimiento | date:'dd/MM/yyyy' }}</td>
                                                <td>{{ cu.montoCuota | number:'1.2-2' }} Gs.</td>
                                                <td>{{ (cu.montoMora ?? 0) | number:'1.2-2' }} Gs.</td>
                                                <td>{{ cu.saldoPendiente | number:'1.2-2' }} Gs.</td>
                                                <td>
                                                    <p-button icon="pi pi-wallet" label="Pagar" [rounded]="true" [text]="true" size="small" (onClick)="openPagarUnaCuota(cr, cu)" />
                                                </td>
                                            </tr>
                                        </ng-template>
                                    </p-table>
                                </div>
                            }
                        </div>
                    </ng-template>
                </p-card>
            }
        </div>
    }
}

<p-card>
    <ng-template #caption>
        <h5 class="m-0">Historial de pagos / Cobranzas</h5>
    </ng-template>
    <ng-template #content>
        <p-table
            #dt
            [value]="pagos()"
            [rows]="10"
            [paginator]="true"
            [tableStyle]="{ 'min-width': '40rem' }"
            dataKey="id"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}"
            [showCurrentPageReport]="true"
            [rowsPerPageOptions]="[10, 25, 50]"
        >
            <ng-template #header>
                <tr>
                    <th style="min-width:6rem">Id</th>
                    <th style="min-width:10rem">Cliente</th>
                    <th style="min-width:8rem">Fecha</th>
                    <th style="min-width:8rem">Monto</th>
                    <th style="min-width:8rem">Medio pago</th>
                </tr>
            </ng-template>
            <ng-template #body let-row>
                <tr>
                    <td>{{ row.id }}</td>
                    <td>{{ getClienteNombre(row.cliente?.id) }}</td>
                    <td>{{ row.creadoEn ? (row.creadoEn | date:'dd/MM/yyyy HH:mm:ss') : (row.fechaPago | date:'dd/MM/yyyy') }}</td>
                    <td>{{ row.montoTotal | number:'1.2-2' }} Gs.</td>
                    <td>{{ row.medioPago?.nombre ?? row.medioPago?.id ?? '—' }}</td>
                </tr>
            </ng-template>
            <ng-template #emptymessage>
                <tr><td colspan="5">No hay pagos.</td></tr>
            </ng-template>
        </p-table>
    </ng-template>
</p-card>

<!-- Dialog: Registrar pago (a documento/cuota o varios) -->
<p-dialog [(visible)]="dialog" [style]="{ width: '600px' }" header="Registrar pago" [modal]="true" (onHide)="onDialogHide()">
    <ng-template #content>
        <div class="flex flex-col gap-4">
            <div>
                <label class="block font-bold mb-2">Cliente *</label>
                @if (pago.cliente?.id) {
                    <div class="flex align-items-center gap-2">
                        <span class="text-color">{{ getClienteNombre(pago.cliente?.id) }}</span>
                        <p-button label="Cambiar" icon="pi pi-pencil" [rounded]="true" [text]="true" size="small" (onClick)="clearClienteEnDialog()" />
                    </div>
                } @else {
                    <p-autocomplete
                        [suggestions]="clientesSugeridos"
                        (completeMethod)="buscarClientes($event)"
                        (onSelect)="onClienteSelectEnDialog($event.value)"
                        optionLabel="razonSocial"
                        placeholder="Buscar por nombre, código o RUC"
                        styleClass="w-full"
                        [dropdown]="false"
                        [minLength]="2"
                        appendTo="body"
                    />
                }
            </div>
            <div class="grid grid-cols-12 gap-4">
                <div class="col-span-6">
                    <label class="block font-bold mb-2">Fecha *</label>
                    <input pInputText type="date" [(ngModel)]="pago.fechaPago" class="w-full" />
                </div>
                <div class="col-span-6">
                    <label class="block font-bold mb-2">Monto total *</label>
                    <p-inputnumber [(ngModel)]="pago.montoTotal" mode="decimal" [minFractionDigits]="2" styleClass="w-full" />
                </div>
            </div>
            <div>
                <label class="block font-bold mb-2">Moneda</label>
                <p-select [(ngModel)]="pago.moneda" [options]="monedas" optionLabel="codigo" placeholder="Moneda" styleClass="w-full" appendTo="body" />
            </div>
            <div>
                <label class="block font-bold mb-2">Medio de pago</label>
                <p-select [(ngModel)]="pago.medioPago" [options]="mediosPago" optionLabel="nombre" placeholder="Medio" styleClass="w-full" appendTo="body" />
            </div>
            <div>
                <label class="block font-bold mb-2">Referencia</label>
                <input pInputText [(ngModel)]="pago.referencia" class="w-full" />
            </div>
            <div>
                <label class="block font-bold mb-2">Aplicaciones *</label>
                <p-table [value]="aplicaciones" [tableStyle]="{ 'min-width': '30rem' }">
                    <ng-template #header>
                        <tr>
                            <th>Tipo</th>
                            <th>Documento / Cuota</th>
                            <th>Monto</th>
                            <th></th>
                        </tr>
                    </ng-template>
                    <ng-template #body let-app>
                        <tr>
                            <td>
                                <p-select [(ngModel)]="app.tipoAplicacion" [options]="tiposAplicacion" optionLabel="label" optionValue="value" appendTo="body" (onChange)="app.documentoVentaId = undefined; app.creditoCuotaId = undefined" />
                            </td>
                            <td>
                                <p-select *ngIf="app.tipoAplicacion === 'DOCUMENTO'" [(ngModel)]="app.documentoVentaId" [options]="documentosConSaldo" optionLabel="numero" optionValue="documentoVentaId" placeholder="Documento" styleClass="w-full" appendTo="body" />
                                <p-select *ngIf="app.tipoAplicacion === 'CUOTA'" [(ngModel)]="app.creditoCuotaId" [options]="cuotasPendientes" optionLabel="label" optionValue="id" placeholder="Cuota" styleClass="w-full" appendTo="body" />
                            </td>
                            <td><p-inputnumber [(ngModel)]="app.montoAplicado" mode="decimal" [minFractionDigits]="2" [min]="0" /></td>
                            <td><p-button icon="pi pi-trash" severity="danger" [rounded]="true" [text]="true" (click)="removeAplicacion(app)" /></td>
                        </tr>
                    </ng-template>
                    <ng-template #emptymessage>
                        <tr><td colspan="4">Sin aplicaciones. Agregar abajo.</td></tr>
                    </ng-template>
                </p-table>
                <p-button label="Agregar aplicación" icon="pi pi-plus" [rounded]="true" [outlined]="true" (click)="addAplicacion()" class="mt-2" />
            </div>
        </div>
    </ng-template>
    <ng-template #footer>
        <p-button label="Cancelar" icon="pi pi-times" text (click)="hideDialog()" />
        <p-button label="Registrar" icon="pi pi-check" (click)="registrar()" />
    </ng-template>
</p-dialog>

<!-- Dialog: Cancelación anticipada del préstamo -->
<p-dialog [(visible)]="dialogCancelacion" [style]="{ width: '440px' }" header="Cancelar préstamo" [modal]="true" (onHide)="hideDialogCancelacion()">
    <ng-template #content>
        @if (creditoCancelar) {
            <div class="flex flex-col gap-4">
                <p class="text-color-secondary">
                    Se registrará un pago por el capital pendiente recalculado y se darán de baja las cuotas pendientes del crédito <strong>{{ creditoCancelar.creditoId }}</strong>.
                </p>
                <div class="surface-100 border-round p-3">
                    <label class="block text-sm font-medium text-color-secondary mb-1">Monto a pagar (capital pendiente / saldo deudor)</label>
                    <span class="text-xl font-bold">{{ creditoCancelar.cancelacionAnticipada.montoTotal | number:'1.2-2' }} Gs.</span>
                </div>
                <div>
                    <label class="block font-bold mb-2">Fecha de pago *</label>
                    <input pInputText type="date" [(ngModel)]="cancelacionFecha" class="w-full" />
                </div>
                <div>
                    <label class="block font-bold mb-2">Medio de pago</label>
                    <p-select [(ngModel)]="cancelacionMedioPagoId" [options]="mediosPago" optionLabel="nombre" optionValue="id" placeholder="Medio" styleClass="w-full" appendTo="body"
                        (onChange)="cancelacionMedioPagoId = $event.value ?? null" />
                </div>
                <div>
                    <label class="block font-bold mb-2">Referencia</label>
                    <input pInputText [(ngModel)]="cancelacionReferencia" class="w-full" />
                </div>
                <div>
                    <label class="block font-bold mb-2">Observaciones</label>
                    <input pInputText [(ngModel)]="cancelacionObservaciones" class="w-full" />
                </div>
            </div>
        }
    </ng-template>
    <ng-template #footer>
        <p-button label="Cerrar" icon="pi pi-times" text (click)="hideDialogCancelacion()" />
        <p-button label="Confirmar cancelación" icon="pi pi-check" severity="danger" (click)="confirmarCancelacion()" />
    </ng-template>
</p-dialog>
