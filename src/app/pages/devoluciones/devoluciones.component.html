<p-toast />
<p-confirmdialog />
<p-toolbar styleClass="mb-6">
    <ng-template #start>
        <p-button label="Nueva devolución" icon="pi pi-plus" severity="secondary" (onClick)="openNew()" />
    </ng-template>
</p-toolbar>

<p-table
    #dt
    [value]="devoluciones()"
    [rows]="10"
    [paginator]="true"
    [globalFilterFields]="['estado']"
    [tableStyle]="{ 'min-width': '50rem' }"
    dataKey="id"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}"
    [showCurrentPageReport]="true"
    [rowsPerPageOptions]="[10, 25, 50]"
>
    <ng-template #caption>
        <div class="flex items-center justify-between">
            <h5 class="m-0">Devoluciones de venta</h5>
            <p-iconfield>
                <p-inputicon styleClass="pi pi-search" />
                <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Buscar..." />
            </p-iconfield>
        </div>
    </ng-template>
    <ng-template #header>
        <tr>
            <th style="min-width:6rem">Id</th>
            <th style="min-width:10rem">Documento</th>
            <th style="min-width:8rem">Fecha</th>
            <th style="min-width:8rem">Estado</th>
            <th style="min-width:14rem"></th>
        </tr>
    </ng-template>
    <ng-template #body let-row>
        <tr>
            <td>{{ row.id }}</td>
            <td>Doc #{{ row.documentoVenta?.id }}</td>
            <td>{{ row.creadoEn ? (row.creadoEn | date:'dd/MM/yyyy HH:mm:ss') : (row.fechaDevolucion | date:'dd/MM/yyyy') }}</td>
            <td><p-tag [value]="row.estado ?? '-'" [severity]="getEstadoSeverity(row.estado)" /></td>
            <td>
                <p-button
                    *ngIf="row.estado === 'PENDIENTE'"
                    icon="pi pi-check"
                    label="Aprobar"
                    [rounded]="true"
                    [outlined]="true"
                    (click)="aprobar(row)"
                    class="mr-2"
                />
                <p-button
                    *ngIf="row.estado === 'PENDIENTE'"
                    icon="pi pi-times"
                    label="Rechazar"
                    severity="danger"
                    [rounded]="true"
                    [outlined]="true"
                    (click)="rechazar(row)"
                    class="mr-2"
                />
            </td>
        </tr>
    </ng-template>
    <ng-template #emptymessage>
        <tr><td colspan="5">No hay devoluciones.</td></tr>
    </ng-template>
</p-table>

<p-dialog [(visible)]="dialog" [style]="{ width: '640px' }" header="Nueva devolución" [modal]="true" (onHide)="onDialogHide()">
    <ng-template #content>
        <div class="flex flex-col gap-4">
            <div>
                <label class="block font-bold mb-2">Documento de venta *</label>
                <p-select
                    [(ngModel)]="selectedDocumento"
                    [options]="documentos"
                    optionLabel="numero"
                    placeholder="Seleccione documento"
                    styleClass="w-full"
                    (onChange)="onDocumentoSelect()"
                    [filter]="true"
                >
                    <ng-template let-d pTemplate="item">
                        {{ d.establecimiento }}-{{ d.puntoEmision }}-{{ d.numero }} ({{ d.cliente?.id }})
                    </ng-template>
                </p-select>
            </div>
            <div>
                <label class="block font-bold mb-2">Fecha devolución</label>
                <input pInputText type="date" [(ngModel)]="devolucion.fechaDevolucion" class="w-full" />
            </div>
            <div>
                <label class="block font-bold mb-2">Líneas a devolver</label>
                <p-table [value]="lineasDevolucion" [tableStyle]="{ 'min-width': '30rem' }">
                    <ng-template #header>
                        <tr>
                            <th>Producto / Descripción</th>
                            <th>Cant. original</th>
                            <th>Cant. a devolver</th>
                            <th>Motivo</th>
                        </tr>
                    </ng-template>
                    <ng-template #body let-line>
                        <tr>
                            <td>{{ line.descripcion ?? 'Línea ' + line.nroLinea }}</td>
                            <td>{{ line.cantidad }}</td>
                            <td><p-inputnumber [(ngModel)]="line.cantidadDevuelta" [min]="0" [max]="line.cantidad" /></td>
                            <td><input pInputText [(ngModel)]="line.motivo" placeholder="Motivo" class="w-full" /></td>
                        </tr>
                    </ng-template>
                    <ng-template #emptymessage>
                        <tr><td colspan="4">Seleccione un documento para ver líneas.</td></tr>
                    </ng-template>
                </p-table>
            </div>
            <div>
                <label class="block font-bold mb-2">Observaciones</label>
                <textarea pInputText [(ngModel)]="devolucion.observaciones" class="w-full" rows="2"></textarea>
            </div>
        </div>
    </ng-template>
    <ng-template #footer>
        <p-button label="Cancelar" icon="pi pi-times" text (click)="hideDialog()" />
        <p-button label="Crear devolución" icon="pi pi-check" (click)="save()" />
    </ng-template>
</p-dialog>
