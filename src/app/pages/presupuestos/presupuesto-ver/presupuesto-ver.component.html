<p-toast />
<p-confirmdialog />
<p-dialog
    [visible]="enviarResultado() !== null"
    [modal]="true"
    [closable]="true"
    [style]="{ width: 'min(480px, 100vw - 2rem)' }"
    header="Enlace para el cliente"
    (onHide)="cerrarDialogoEnlace()"
>
    @if (enviarResultado()) {
        <p class="text-color mb-3">Compartí este enlace y el código de seguridad con el cliente para que pueda ver el presupuesto y aprobar o rechazarlo.</p>
        <div class="flex flex-col gap-3">
            <div>
                <label class="block text-sm font-semibold text-muted-color mb-1">Enlace</label>
                <div class="flex gap-2">
                    <input pInputText [readonly]="true" [value]="linkEnviado" class="flex-1 font-mono text-sm" />
                    <p-button icon="pi pi-copy" label="Copiar" (onClick)="copiarEnlace()" />
                </div>
            </div>
            <div>
                <label class="block text-sm font-semibold text-muted-color mb-1">Código de seguridad</label>
                <p class="font-mono text-xl font-bold text-primary m-0">{{ codigoEnviado }}</p>
                <span class="text-sm text-muted-color">El cliente debe ingresar este código para acceder.</span>
            </div>
        </div>
        <ng-template pTemplate="footer">
            <p-button icon="pi pi-whatsapp" label="Enviar por WhatsApp" severity="success" (onClick)="enviarAWhatsApp()" />
            <p-button label="Cerrar" (onClick)="cerrarDialogoEnlace()" />
        </ng-template>
    }
</p-dialog>
<div class="presupuesto-ver-page">
    <!-- Cabecera: navegación, título, estado y acciones -->
    <header class="presupuesto-ver-header">
        <div class="presupuesto-ver-header-left">
            <p-button icon="pi pi-arrow-left" [rounded]="true" [text]="true" (onClick)="volver()" ariaLabel="Volver a la lista" />
            <div class="presupuesto-ver-title-block">
                <h1 class="presupuesto-ver-title">Presupuesto {{ presupuesto()?.numero || presupuesto()?.id }}</h1>
                @if (presupuesto()?.estado) {
                    <p-tag [value]="getEstadoLabel(presupuesto()?.estado)" [severity]="getEstadoSeverity(presupuesto()?.estado)" styleClass="presupuesto-ver-badge" />
                }
            </div>
        </div>
        <div class="presupuesto-ver-actions">
            <p-button icon="pi pi-file-pdf" label="Exportar PDF" (onClick)="exportarPdf()" [loading]="exportandoPdf()" styleClass="presupuesto-ver-btn-primary" />
            @if (presupuesto()?.estado === 'ENVIADO') {
                <p-button icon="pi pi-whatsapp" label="Enviar por WhatsApp" severity="success" [outlined]="true" (onClick)="enviarAWhatsAppDesdeVer()" title="Compartir enlace y código con el cliente" />
            }
            @if (presupuesto()?.estado === 'BORRADOR') {
                <p-button icon="pi pi-pencil" label="Editar" [outlined]="true" (onClick)="editar()" />
                <p-button icon="pi pi-send" label="Enviar" [outlined]="true" (onClick)="enviar()" />
            }
            @if (presupuesto()?.estado === 'ENVIADO') {
                <p-button icon="pi pi-check" label="Aprobar" [outlined]="true" (onClick)="aprobar()" />
                <p-button icon="pi pi-times" label="Rechazar" severity="danger" [outlined]="true" (onClick)="rechazar()" />
            }
            @if (presupuesto()?.estado === 'APROBADO') {
                <p-button icon="pi pi-truck" label="Convertir a pedido" [outlined]="true" (onClick)="convertirAPedido()" />
            }
            @if (presupuesto()?.pedidoId) {
                <p-button icon="pi pi-external-link" label="Ir a pedido" [outlined]="true" (onClick)="irAPedido()" />
            }
        </div>
    </header>

    @if (loading()) {
        <div class="presupuesto-ver-loading">
            <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
            <p class="text-muted-color mt-3 mb-0">Cargando presupuesto...</p>
        </div>
    } @else if (presupuesto()) {
        <div class="doc-ver-layout">
            <p-card header="Datos generales" styleClass="doc-ver-datos presupuesto-ver-card">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-4">
                    <div class="col-span-2 md:col-span-1">
                        <span class="block text-muted-color text-sm font-medium mb-0.5">Cliente</span>
                        <span class="font-semibold text-color">{{ clienteNombre() }}</span>
                    </div>
                    <div>
                        <span class="block text-muted-color text-sm font-medium mb-0.5">Número</span>
                        <span class="text-color">{{ presupuesto()?.numero || presupuesto()?.id }}</span>
                    </div>
                    <div>
                        <span class="block text-muted-color text-sm font-medium mb-0.5">Fecha emisión</span>
                        <span class="text-color">{{ presupuesto()?.fechaEmision ? (presupuesto()?.fechaEmision | date:'d/M/yyyy') : '—' }}</span>
                    </div>
                    <div>
                        <span class="block text-muted-color text-sm font-medium mb-0.5">Validez hasta</span>
                        <span class="text-color">{{ presupuesto()?.fechaValidez ? (presupuesto()?.fechaValidez | date:'d/M/yyyy') : '—' }}</span>
                    </div>
                    <div>
                        <span class="block text-muted-color text-sm font-medium mb-0.5">Tipo pedido</span>
                        <span class="text-color">{{ presupuesto()?.tipoPedido === 'RETIRO' ? 'Retiro' : 'Delivery' }}</span>
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <span class="block text-muted-color text-sm font-medium mb-0.5">Dirección entrega</span>
                        <span class="text-color">{{ presupuesto()?.direccionEntrega || '—' }}</span>
                    </div>
                    <div>
                        <span class="block text-muted-color text-sm font-medium mb-0.5">Teléfono</span>
                        <span class="text-color">{{ presupuesto()?.telefonoContacto || '—' }}</span>
                    </div>
                    @if (presupuesto()?.observaciones) {
                        <div class="col-span-2 md:col-span-4">
                            <span class="block text-muted-color text-sm font-medium mb-0.5">Observaciones</span>
                            <span class="text-color">{{ presupuesto()?.observaciones }}</span>
                        </div>
                    }
                </div>
            </p-card>

            <p-card header="Detalle" styleClass="doc-ver-detalle-card presupuesto-ver-card">
                <div class="doc-ver-tabla-wrap overflow-x-auto overflow-y-auto max-h-[min(24rem,60vh)] border border-surface-200 dark:border-surface-600 rounded-lg">
                    <p-table [value]="presupuesto()?.detalle ?? []" [tableStyle]="{ 'min-width': '100%' }" styleClass="p-datatable-sm p-datatable-striped doc-ver-tabla">
                        <ng-template #header>
                            <tr>
                                <th class="font-semibold">Descripción</th>
                                <th class="text-right w-24">Cant.</th>
                                <th class="text-right w-28">P. unit.</th>
                                <th class="text-right w-28">Total</th>
                            </tr>
                        </ng-template>
                        <ng-template #body let-line>
                            <tr>
                                <td class="text-color">{{ getDescripcionLinea(line) }}</td>
                                <td class="text-right text-color">{{ line.cantidad | number:'1.2-2' }}</td>
                                <td class="text-right text-color">{{ line.precioUnitario | number:'1.0-0' }} Gs.</td>
                                <td class="text-right font-semibold text-color">{{ line.totalLinea | number:'1.0-0' }} Gs.</td>
                            </tr>
                        </ng-template>
                        <ng-template #emptymessage>
                            <tr><td colspan="4" class="text-center py-4 text-muted-color">Sin líneas.</td></tr>
                        </ng-template>
                    </p-table>
                </div>
                <div class="flex justify-end items-center gap-2 mt-4 pt-4 border-t border-surface-200 dark:border-surface-600">
                    <span class="font-bold text-color">Total:</span>
                    <span class="font-bold text-primary text-lg">{{ presupuesto()?.total | number:'1.0-0' }} Gs.</span>
                </div>
            </p-card>
        </div>
    }
</div>
