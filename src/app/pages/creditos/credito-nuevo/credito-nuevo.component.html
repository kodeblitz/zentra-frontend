<p-toast />
<div class="max-w-6xl mx-auto w-full px-2 md:px-4">
    <header class="mb-4">
        <div class="flex align-items-center gap-2">
            <p-button icon="pi pi-arrow-left" [rounded]="true" [text]="true" (onClick)="volver()" aria-label="Volver" />
            <h1 class="m-0">Nuevo crédito</h1>
        </div>
        <p class="text-color-secondary mt-1 mb-0">Complete los parámetros y revise el cálculo de cuotas antes de crear.</p>
    </header>

    <div class="grid">
        <div class="col-12 lg:col-5">
            <p-card header="Parámetros del crédito">
                <div class="flex flex-col gap-4">
                    <div class="grid">
                        <div class="col-12 md:col-6">
                            <label class="block font-semibold mb-2 text-color">Cliente <span class="text-red-500">*</span></label>
                            <p-autocomplete
                                [(ngModel)]="selectedCliente"
                                [suggestions]="clientesSugeridos"
                                (completeMethod)="buscarClientes($event)"
                                (onSelect)="onClienteSelect()"
                                (onClear)="credito.cliente = undefined; selectedCliente = null"
                                optionLabel="razonSocial"
                                placeholder="Buscar por nombre, código o RUC (mín. 2 caracteres)"
                                styleClass="w-full"
                                [dropdown]="false"
                                [showClear]="true"
                                [minLength]="2"
                                inputStyleClass="w-full"
                            />
                        </div>
                        <div class="col-12 md:col-6">
                            <label class="block font-semibold mb-2 text-color">Moneda <span class="text-red-500">*</span></label>
                            <p-select
                                [(ngModel)]="credito.moneda"
                                [options]="monedas"
                                optionLabel="codigo"
                                dataKey="id"
                                placeholder="Seleccione moneda"
                                styleClass="w-full"
                                [showClear]="true"
                                (onChange)="credito.moneda = $event.value ? { id: $event.value.id } : undefined"
                            />
                        </div>
                    </div>
                    <div class="grid">
                        <div class="col-12 md:col-4">
                            <label class="block font-semibold mb-2 text-color">Monto total <span class="text-red-500">*</span></label>
                            <p-inputnumber
                                [(ngModel)]="credito.montoTotal"
                                (ngModelChange)="onParamsChange()"
                                mode="decimal"
                                [minFractionDigits]="2"
                                [min]="0.01"
                                placeholder="0,00"
                                styleClass="w-full"
                                inputStyleClass="w-full"
                            />
                        </div>
                        <div class="col-12 md:col-4">
                            <label class="block font-semibold mb-2 text-color">Nº cuotas</label>
                            <p-inputnumber [(ngModel)]="credito.nroCuotas" (ngModelChange)="onParamsChange()" [min]="1" [max]="360" styleClass="w-full" />
                        </div>
                        <div class="col-12 md:col-4">
                            <label class="block font-semibold mb-2 text-color">Tasa % anual</label>
                            <p-inputnumber [(ngModel)]="credito.tasaInteresAnual" (ngModelChange)="onParamsChange()" [min]="0" styleClass="w-full" />
                        </div>
                        <div class="col-12 md:col-4">
                            <label class="block font-semibold mb-2 text-color">Tasa mora % anual</label>
                            <p-inputnumber [(ngModel)]="credito.tasaMoraAnual" (ngModelChange)="onParamsChange()" [min]="0" styleClass="w-full" placeholder="Opcional" />
                            <small class="block text-color-secondary text-sm mt-1">Interés moratorio tras días de gracia</small>
                        </div>
                        <div class="col-12 md:col-4">
                            <label class="block font-semibold mb-2 text-color">Días de gracia</label>
                            <p-inputnumber [(ngModel)]="credito.diasGracia" (ngModelChange)="onParamsChange()" [min]="0" styleClass="w-full" />
                            <small class="block text-color-secondary text-sm mt-1">Días sin mora tras vencimiento</small>
                        </div>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2 text-color">Sistema de amortización</label>
                        <p-select
                            [(ngModel)]="credito.sistemaAmort"
                            (ngModelChange)="onParamsChange()"
                            [options]="sistemasOpt"
                            optionLabel="label"
                            optionValue="value"
                            styleClass="w-full"
                        />
                    </div>
                    <div class="grid">
                        <div class="col-12 md:col-6">
                            <label class="block font-semibold mb-2 text-color">Fecha inicio</label>
                            <input pInputText type="date" [(ngModel)]="credito.fechaInicio" (ngModelChange)="onParamsChange()" class="w-full" />
                        </div>
                        <div class="col-12 md:col-6">
                            <label class="block font-semibold mb-2 text-color">Primer vencimiento</label>
                            <input pInputText type="date" [(ngModel)]="credito.fechaPrimerVencimiento" (ngModelChange)="onParamsChange()" class="w-full" [placeholder]="fechaPrimerVencimientoCalc" />
                            <small class="block text-color-secondary text-sm mt-1">Si no indica, se usa inicio + 1 mes</small>
                        </div>
                    </div>
                </div>
            </p-card>
        </div>

        <div class="col-12 lg:col-7 mt-4 lg:mt-0">
            <p-card header="Vista previa: cálculo de cuotas">
                @if (cuotasPreview().length === 0) {
                    <div class="flex flex-col align-items-center justify-content-center gap-3 py-8 text-color-secondary">
                        <i class="pi pi-calculator text-6xl"></i>
                        <p class="m-0">Ingrese monto y número de cuotas para ver el detalle.</p>
                    </div>
                } @else {
                    @let resumen = resumenPreview();
                    <div class="flex flex-wrap gap-2 mb-4">
                        <div class="flex-1 min-w-40">
                            <p-card styleClass="h-full">
                                <div class="flex flex-col gap-1">
                                    <span class="block text-color-secondary text-sm font-medium">Principal</span>
                                    <span class="font-semibold text-xl">{{ resumen.montoPrincipal | number:'1.2-2' }} Gs.</span>
                                </div>
                            </p-card>
                        </div>
                        <div class="flex-1 min-w-40">
                            <p-card styleClass="h-full">
                                <div class="flex flex-col gap-1">
                                    <span class="block text-color-secondary text-sm font-medium">Total a pagar</span>
                                    <span class="font-semibold text-xl text-primary">{{ resumen.totalPagar | number:'1.2-2' }} Gs.</span>
                                </div>
                            </p-card>
                        </div>
                        <div class="flex-1 min-w-40">
                            <p-card styleClass="h-full">
                                <div class="flex flex-col gap-1">
                                    <span class="block text-color-secondary text-sm font-medium">Intereses totales</span>
                                    <span class="font-semibold text-xl">{{ resumen.totalIntereses | number:'1.2-2' }} Gs.</span>
                                </div>
                            </p-card>
                        </div>
                        <div class="flex-1 min-w-40">
                            <p-card styleClass="h-full">
                                <div class="flex flex-col gap-1">
                                    <span class="block text-color-secondary text-sm font-medium">1ª cuota</span>
                                    <span class="font-semibold text-xl">{{ resumen.primeraCuota | number:'1.2-2' }} Gs.</span>
                                </div>
                            </p-card>
                        </div>
                        <div class="flex-1 min-w-40">
                            <p-card styleClass="h-full">
                                <div class="flex flex-col gap-1">
                                    <span class="block text-color-secondary text-sm font-medium">Última cuota</span>
                                    <span class="font-semibold text-xl">{{ resumen.ultimaCuota | number:'1.2-2' }} Gs.</span>
                                </div>
                            </p-card>
                        </div>
                    </div>
                    <p-table [value]="cuotasPreview()" [scrollable]="true" scrollHeight="320px" [tableStyle]="{ 'min-width': '40rem' }">
                        <ng-template #header>
                            <tr>
                                <th style="width:3.5rem">Nº</th>
                                <th style="min-width:6rem">Vencimiento</th>
                                <th class="text-right" style="min-width:8rem">Capital</th>
                                <th class="text-right" style="min-width:6rem">Interés</th>
                                <th class="text-right" style="min-width:8rem">Cuota</th>
                                <th class="text-right" style="min-width:8rem">Saldo</th>
                            </tr>
                        </ng-template>
                        <ng-template #body let-c>
                            <tr>
                                <td>{{ c.nroCuota }}</td>
                                <td>{{ c.fechaVencimiento | date:'dd/MM/yyyy HH:mm:ss' }}</td>
                                <td class="text-right">{{ c.montoCapital | number:'1.2-2' }} Gs.</td>
                                <td class="text-right">{{ c.montoInteres | number:'1.2-2' }} Gs.</td>
                                <td class="text-right font-semibold">{{ c.montoCuota | number:'1.2-2' }} Gs.</td>
                                <td class="text-right">{{ c.saldoInsoluto | number:'1.2-2' }} Gs.</td>
                            </tr>
                        </ng-template>
                    </p-table>
                }
            </p-card>
        </div>
    </div>

    <div class="flex justify-content-end gap-2 mt-4 pb-4">
        <p-button label="Cancelar" icon="pi pi-times" [text]="true" (onClick)="volver()" />
        <p-button
            label="Crear crédito"
            icon="pi pi-check"
            (onClick)="crearCredito()"
            [loading]="enviando()"
            [disabled]="cuotasPreview().length === 0"
        />
    </div>
</div>
