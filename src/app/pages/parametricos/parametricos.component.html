<div class="parametricos-container">
    <h2 class="parametricos-title">
        <i class="pi pi-sliders-h"></i>
        Paramétricos
    </h2>
    <p class="parametricos-desc text-color-secondary mb-4">
        Datos base usados en documentos, productos, ventas y cobranzas. Aquí se consultan y mantienen las listas maestras.
    </p>

    <p-tabs [(value)]="activeTab" styleClass="parametricos-tabs">
        <p-tablist>
            <p-tab [value]="0">Categorías de producto</p-tab>
            <p-tab [value]="1">Tipos de documento</p-tab>
            <p-tab [value]="2">Monedas</p-tab>
            <p-tab [value]="3">Condiciones de pago</p-tab>
            <p-tab [value]="4">Unidades de medida</p-tab>
            <p-tab [value]="5">Medios de pago</p-tab>
            <p-tab [value]="6">Empresas</p-tab>
            <p-tab [value]="7">Facturación Paraguay</p-tab>
        </p-tablist>
        <p-tabpanels>
            <p-tabpanel [value]="0">
                <p-table [value]="categorias" [tableStyle]="{ 'min-width': '30rem' }">
                    <ng-template #header>
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                        </tr>
                    </ng-template>
                    <ng-template #body let-row>
                        <tr>
                            <td>{{ row.codigo ?? '-' }}</td>
                            <td>{{ row.nombre ?? '-' }}</td>
                        </tr>
                    </ng-template>
                    <ng-template #emptymessage>
                        <tr><td colspan="2">No hay categorías.</td></tr>
                    </ng-template>
                </p-table>
            </p-tabpanel>
            <p-tabpanel [value]="1">
                <p-table [value]="tiposDocumento" [tableStyle]="{ 'min-width': '30rem' }">
                    <ng-template #header>
                        <tr>
                            <th>Código SET</th>
                            <th>Nombre</th>
                        </tr>
                    </ng-template>
                    <ng-template #body let-row>
                        <tr>
                            <td>{{ row.codigoSet ?? '-' }}</td>
                            <td>{{ row.nombre ?? '-' }}</td>
                        </tr>
                    </ng-template>
                    <ng-template #emptymessage>
                        <tr><td colspan="2">No hay tipos de documento.</td></tr>
                    </ng-template>
                </p-table>
            </p-tabpanel>
            <p-tabpanel [value]="2">
                <p-table [value]="monedas" [tableStyle]="{ 'min-width': '30rem' }">
                    <ng-template #header>
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Símbolo</th>
                        </tr>
                    </ng-template>
                    <ng-template #body let-row>
                        <tr>
                            <td>{{ row.codigo ?? '-' }}</td>
                            <td>{{ row.nombre ?? '-' }}</td>
                            <td>{{ row.simbolo ?? '-' }}</td>
                        </tr>
                    </ng-template>
                    <ng-template #emptymessage>
                        <tr><td colspan="3">No hay monedas.</td></tr>
                    </ng-template>
                </p-table>
            </p-tabpanel>
            <p-tabpanel [value]="3">
                <p-table [value]="condicionesPago" [tableStyle]="{ 'min-width': '30rem' }">
                    <ng-template #header>
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Días</th>
                        </tr>
                    </ng-template>
                    <ng-template #body let-row>
                        <tr>
                            <td>{{ row.codigo ?? '-' }}</td>
                            <td>{{ row.nombre ?? '-' }}</td>
                            <td>{{ row.dias ?? 0 }}</td>
                        </tr>
                    </ng-template>
                    <ng-template #emptymessage>
                        <tr><td colspan="3">No hay condiciones de pago.</td></tr>
                    </ng-template>
                </p-table>
            </p-tabpanel>
            <p-tabpanel [value]="4">
                <p-table [value]="unidadesMedida" [tableStyle]="{ 'min-width': '30rem' }">
                    <ng-template #header>
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                        </tr>
                    </ng-template>
                    <ng-template #body let-row>
                        <tr>
                            <td>{{ row.codigo ?? '-' }}</td>
                            <td>{{ row.nombre ?? '-' }}</td>
                        </tr>
                    </ng-template>
                    <ng-template #emptymessage>
                        <tr><td colspan="2">No hay unidades de medida.</td></tr>
                    </ng-template>
                </p-table>
            </p-tabpanel>
            <p-tabpanel [value]="5">
                <p-table [value]="mediosPago" [tableStyle]="{ 'min-width': '30rem' }">
                    <ng-template #header>
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                        </tr>
                    </ng-template>
                    <ng-template #body let-row>
                        <tr>
                            <td>{{ row.codigo ?? '-' }}</td>
                            <td>{{ row.nombre ?? '-' }}</td>
                        </tr>
                    </ng-template>
                    <ng-template #emptymessage>
                        <tr><td colspan="2">No hay medios de pago.</td></tr>
                    </ng-template>
                </p-table>
            </p-tabpanel>
            <p-tabpanel [value]="6">
                <p-table [value]="empresas" [tableStyle]="{ 'min-width': '40rem' }">
                    <ng-template #header>
                        <tr>
                            <th>Razón social</th>
                            <th>RUC</th>
                        </tr>
                    </ng-template>
                    <ng-template #body let-row>
                        <tr>
                            <td>{{ row.razonSocial ?? '-' }}</td>
                            <td>{{ row.ruc ?? '-' }}</td>
                        </tr>
                    </ng-template>
                    <ng-template #emptymessage>
                        <tr><td colspan="2">No hay empresas.</td></tr>
                    </ng-template>
                </p-table>
            </p-tabpanel>
            <p-tabpanel [value]="7">
                <div class="flex flex-col gap-4">
                    <div class="surface-ground border border-surface-200 dark:border-surface-600 rounded-lg p-4">
                        <h4 class="mt-0 mb-3">Establecimiento y punto de expedición por defecto</h4>
                        <p class="text-color-secondary text-sm mb-3">Para facturación física Paraguay el número sigue el formato 001-002-0000145 (establecimiento - punto de expedición - consecutivo). Podés usar una sucursal por defecto o los valores de la empresa.</p>
                        @if (empresas.length > 0) {
                            <div class="flex flex-col gap-4">
                                <div class="flex flex-wrap items-end gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Empresa</label>
                                        <p-select
                                            [ngModel]="facturacionEmpresa?.id"
                                            (ngModelChange)="onEmpresaIdChange($event)"
                                            [options]="empresas"
                                            optionLabel="razonSocial"
                                            optionValue="id"
                                            placeholder="Seleccione"
                                            styleClass="min-w-[16rem]"
                                        />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Sucursal por defecto al facturar</label>
                                        <p-select
                                            [ngModel]="facturacionEmpresa?.sucursalDefault?.id"
                                            (ngModelChange)="facturacionEmpresa!.sucursalDefault = $event != null ? { id: $event } : undefined"
                                            [options]="sucursalesConNinguna"
                                            optionLabel="label"
                                            optionValue="id"
                                            placeholder="Ninguna (usar valores abajo)"
                                            styleClass="min-w-[14rem]"
                                        />
                                    </div>
                                    @if (!facturacionEmpresa?.sucursalDefault?.id) {
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Establecimiento (ej. 001)</label>
                                            <input pInputText [(ngModel)]="facturacionEmpresa!.establecimientoDefault" class="w-24" maxlength="5" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Punto de expedición (ej. 001)</label>
                                            <input pInputText [(ngModel)]="facturacionEmpresa!.puntoEmisionDefault" class="w-24" maxlength="5" />
                                        </div>
                                    } @else {
                                        <span class="text-color-secondary text-sm">Se usan establecimiento y punto de la sucursal seleccionada.</span>
                                    }
                                    <p-button label="Guardar" icon="pi pi-check" (onClick)="guardarFacturacionDefaults()" [loading]="guardandoFacturacion" />
                                </div>
                            </div>
                        } @else {
                            <p class="text-color-secondary">No hay empresas configuradas.</p>
                        }
                    </div>
                    <div class="surface-ground border border-surface-200 dark:border-surface-600 rounded-lg p-4">
                        <h4 class="mt-0 mb-3">Sucursales</h4>
                        <p class="text-color-secondary text-sm mb-3">Cada sucursal tiene su código de establecimiento y punto de expedición. Al elegir una como "por defecto al facturar", las facturas usarán esos valores.</p>
                        <p-button label="Nueva sucursal" icon="pi pi-plus" severity="secondary" (onClick)="openNewSucursal()" class="mb-3" />
                        <p-table [value]="sucursales" [tableStyle]="{ 'min-width': '40rem' }">
                            <ng-template #header>
                                <tr>
                                    <th>Código</th>
                                    <th>Nombre</th>
                                    <th>Estab.</th>
                                    <th>Pto. exped.</th>
                                    <th>Activo</th>
                                    <th></th>
                                </tr>
                            </ng-template>
                            <ng-template #body let-row>
                                <tr>
                                    <td>{{ row.codigo ?? '-' }}</td>
                                    <td>{{ row.nombre ?? '-' }}</td>
                                    <td>{{ row.establecimiento ?? '-' }}</td>
                                    <td>{{ row.puntoEmision ?? '-' }}</td>
                                    <td><p-tag [value]="row.activo ? 'Sí' : 'No'" [severity]="row.activo ? 'success' : 'secondary'" /></td>
                                    <td>
                                        <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" (onClick)="editSucursal(row)" class="mr-1" />
                                        <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [text]="true" (onClick)="eliminarSucursal(row)" />
                                    </td>
                                </tr>
                            </ng-template>
                            <ng-template #emptymessage>
                                <tr><td colspan="6">No hay sucursales. Agregá al menos una para usar establecimientos por sucursal.</td></tr>
                            </ng-template>
                        </p-table>
                    </div>
                    <div class="surface-ground border border-surface-200 dark:border-surface-600 rounded-lg p-4">
                        <h4 class="mt-0 mb-3">Timbrados (vigencia)</h4>
                        <p class="text-color-secondary text-sm mb-3">Los timbrados tienen fecha de inicio y fin de vigencia. Al emitir una factura se asocia el timbrado vigente para esa fecha.</p>
                        <p-button label="Nuevo timbrado" icon="pi pi-plus" severity="secondary" (onClick)="openNewTimbrado()" class="mb-3" />
                        <p-table [value]="timbrados" [tableStyle]="{ 'min-width': '36rem' }">
                            <ng-template #header>
                                <tr>
                                    <th>Número timbrado</th>
                                    <th>Inicio vigencia</th>
                                    <th>Fin vigencia</th>
                                    <th>Activo</th>
                                    <th></th>
                                </tr>
                            </ng-template>
                            <ng-template #body let-row>
                                <tr>
                                    <td>{{ row.numeroTimbrado ?? '-' }}</td>
                                    <td>{{ row.fechaInicioVigencia | date:'d/M/yyyy' }}</td>
                                    <td>{{ row.fechaFinVigencia | date:'d/M/yyyy' }}</td>
                                    <td><p-tag [value]="row.activo ? 'Sí' : 'No'" [severity]="row.activo ? 'success' : 'secondary'" /></td>
                                    <td>
                                        <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" (onClick)="editTimbrado(row)" class="mr-1" />
                                        <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [text]="true" (onClick)="eliminarTimbrado(row)" />
                                    </td>
                                </tr>
                            </ng-template>
                            <ng-template #emptymessage>
                                <tr><td colspan="5">No hay timbrados. Agregá uno para facturación física.</td></tr>
                            </ng-template>
                        </p-table>
                    </div>
                </div>
            </p-tabpanel>
        </p-tabpanels>
    </p-tabs>

    <p-dialog [(visible)]="dialogSucursal" [header]="sucursalEdit.id ? 'Editar sucursal' : 'Nueva sucursal'" [modal]="true" [style]="{ width: '420px' }" (onHide)="dialogSucursal = false">
        <div class="flex flex-col gap-3">
            <div>
                <label class="block text-sm font-medium mb-1">Código</label>
                <input pInputText [(ngModel)]="sucursalEdit.codigo" class="w-full" placeholder="Ej. SUC001" />
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Nombre</label>
                <input pInputText [(ngModel)]="sucursalEdit.nombre" class="w-full" placeholder="Ej. Casa central" />
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-sm font-medium mb-1">Establecimiento</label>
                    <input pInputText [(ngModel)]="sucursalEdit.establecimiento" class="w-full" placeholder="001" maxlength="5" />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Punto expedición</label>
                    <input pInputText [(ngModel)]="sucursalEdit.puntoEmision" class="w-full" placeholder="001" maxlength="5" />
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Dirección</label>
                <input pInputText [(ngModel)]="sucursalEdit.direccion" class="w-full" placeholder="Opcional" />
            </div>
            <div class="flex items-center gap-2">
                <p-checkbox [(ngModel)]="sucursalEdit.activo" [binary]="true" inputId="sucursalActivo" />
                <label for="sucursalActivo">Activo</label>
            </div>
        </div>
        <ng-template #footer>
            <p-button label="Cancelar" icon="pi pi-times" text (onClick)="dialogSucursal = false" />
            <p-button label="Guardar" icon="pi pi-check" (onClick)="guardarSucursal()" [loading]="guardandoSucursal" />
        </ng-template>
    </p-dialog>

    <p-dialog [(visible)]="dialogTimbrado" [header]="timbradoEdit.id ? 'Editar timbrado' : 'Nuevo timbrado'" [modal]="true" [style]="{ width: '420px' }" (onHide)="dialogTimbrado = false">
        <div class="flex flex-col gap-3">
            @if (!timbradoEdit.id && empresas.length > 1) {
                <div>
                    <label class="block text-sm font-medium mb-1">Empresa</label>
                    <p-select
                        [ngModel]="timbradoEdit.empresa?.id"
                        (ngModelChange)="timbradoEdit.empresa = $event != null ? { id: $event } : undefined"
                        [options]="empresas"
                        optionLabel="razonSocial"
                        optionValue="id"
                        placeholder="Seleccione"
                        styleClass="w-full"
                    />
                </div>
            }
            <div>
                <label class="block text-sm font-medium mb-1">Número timbrado</label>
                <input pInputText [(ngModel)]="timbradoEdit.numeroTimbrado" class="w-full" placeholder="Ej. 18196811" />
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Fecha inicio vigencia</label>
                <input pInputText type="date" [(ngModel)]="timbradoEdit.fechaInicioVigencia" class="w-full" />
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Fecha fin vigencia</label>
                <input pInputText type="date" [(ngModel)]="timbradoEdit.fechaFinVigencia" class="w-full" />
            </div>
            <div class="flex items-center gap-2">
                <p-checkbox [(ngModel)]="timbradoEdit.activo" [binary]="true" inputId="timbradoActivo" />
                <label for="timbradoActivo">Activo</label>
            </div>
        </div>
        <ng-template #footer>
            <p-button label="Cancelar" icon="pi pi-times" text (onClick)="dialogTimbrado = false" />
            <p-button label="Guardar" icon="pi pi-check" (onClick)="guardarTimbrado()" [loading]="guardandoTimbrado" />
        </ng-template>
    </p-dialog>
</div>

<p-toast />
<p-confirmdialog />
