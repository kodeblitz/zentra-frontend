<p-toast />
<p-confirmdialog />
<div class="presupuesto-ver-page">
    <div class="flex align-items-center justify-content-between gap-2 mb-4 flex-wrap">
        <div class="flex align-items-center gap-2">
            <p-button icon="pi pi-arrow-left" [rounded]="true" [text]="true" (onClick)="volver()" />
            <h2 class="m-0">Presupuesto {{ presupuesto()?.numero || presupuesto()?.id }}</h2>
            @if (presupuesto()?.estado) {
                <p-tag [value]="getEstadoLabel(presupuesto()?.estado)" [severity]="getEstadoSeverity(presupuesto()?.estado)" />
            }
        </div>
        <div class="flex gap-2 flex-wrap">
            <p-button icon="pi pi-file-pdf" label="Exportar PDF" [rounded]="true" [outlined]="true" (onClick)="exportarPdf()" [loading]="exportandoPdf()" />
            @if (presupuesto()?.estado === 'BORRADOR') {
                <p-button icon="pi pi-pencil" label="Editar" [rounded]="true" [outlined]="true" (onClick)="editar()" />
                <p-button icon="pi pi-send" label="Enviar" [rounded]="true" [outlined]="true" (onClick)="enviar()" />
            }
            @if (presupuesto()?.estado === 'ENVIADO') {
                <p-button icon="pi pi-check" label="Aprobar" [rounded]="true" [outlined]="true" (onClick)="aprobar()" />
                <p-button icon="pi pi-times" label="Rechazar" severity="danger" [rounded]="true" [outlined]="true" (onClick)="rechazar()" />
            }
            @if (presupuesto()?.estado === 'APROBADO') {
                <p-button icon="pi pi-truck" label="Convertir a pedido" [rounded]="true" [outlined]="true" (onClick)="convertirAPedido()" />
            }
            @if (presupuesto()?.pedidoId) {
                <p-button icon="pi pi-external-link" label="Ir a pedido" [rounded]="true" [outlined]="true" (onClick)="irAPedido()" />
            }
        </div>
    </div>

    @if (loading()) {
        <p class="text-color-secondary">Cargando...</p>
    } @else if (presupuesto()) {
        <div class="grid">
            <div class="col-12">
                <div class="card p-4 mb-4">
                    <h3 class="mt-0 mb-3">Datos generales</h3>
                    <div class="grid">
                        <div class="col-12 md:col-6">
                            <span class="text-color-secondary block mb-1">Cliente</span>
                            <span class="font-semibold">{{ clienteNombre() }}</span>
                        </div>
                        <div class="col-12 md:col-2">
                            <span class="text-color-secondary block mb-1">Número</span>
                            <span>{{ presupuesto()?.numero || presupuesto()?.id }}</span>
                        </div>
                        <div class="col-12 md:col-2">
                            <span class="text-color-secondary block mb-1">Fecha emisión</span>
                            <span>{{ presupuesto()?.fechaEmision || '-' }}</span>
                        </div>
                        <div class="col-12 md:col-2">
                            <span class="text-color-secondary block mb-1">Validez hasta</span>
                            <span>{{ presupuesto()?.fechaValidez || '-' }}</span>
                        </div>
                        <div class="col-12 md:col-4">
                            <span class="text-color-secondary block mb-1">Tipo pedido</span>
                            <span>{{ presupuesto()?.tipoPedido === 'RETIRO' ? 'Retiro' : 'Delivery' }}</span>
                        </div>
                        <div class="col-12 md:col-4">
                            <span class="text-color-secondary block mb-1">Dirección entrega</span>
                            <span>{{ presupuesto()?.direccionEntrega || '-' }}</span>
                        </div>
                        <div class="col-12 md:col-2">
                            <span class="text-color-secondary block mb-1">Teléfono</span>
                            <span>{{ presupuesto()?.telefonoContacto || '-' }}</span>
                        </div>
                        @if (presupuesto()?.observaciones) {
                            <div class="col-12">
                                <span class="text-color-secondary block mb-1">Observaciones</span>
                                <span>{{ presupuesto()?.observaciones }}</span>
                            </div>
                        }
                    </div>
                </div>

                <div class="card p-4 mb-4">
                    <h3 class="mt-0 mb-3">Detalle</h3>
                    <p-table [value]="presupuesto()?.detalle ?? []" [tableStyle]="{ 'min-width': '40rem' }">
                        <ng-template #header>
                            <tr>
                                <th>Descripción</th>
                                <th class="text-right">Cantidad</th>
                                <th class="text-right">P. unit.</th>
                                <th class="text-right">Total</th>
                            </tr>
                        </ng-template>
                        <ng-template #body let-line>
                            <tr>
                                <td>{{ getDescripcionLinea(line) }}</td>
                                <td class="text-right">{{ line.cantidad | number:'1.2-2' }}</td>
                                <td class="text-right">{{ line.precioUnitario | number:'1.2-2' }}</td>
                                <td class="text-right">{{ line.totalLinea | number:'1.2-2' }}</td>
                            </tr>
                        </ng-template>
                        <ng-template #emptymessage>
                            <tr><td colspan="4">Sin líneas.</td></tr>
                        </ng-template>
                    </p-table>
                    <div class="flex justify-end gap-2 mt-3 font-bold text-lg">
                        <span>Total:</span><span>{{ presupuesto()?.total | number:'1.2-2' }}</span>
                    </div>
                </div>
            </div>
        </div>
    }
</div>
