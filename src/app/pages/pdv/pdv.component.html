<p-toast />
<div class="flex flex-col flex-1 min-h-0 bg-surface-ground">
    <!-- Barra superior: jerarquía clara -->
    <header class="flex flex-wrap items-center gap-4 p-4 mb-4 rounded-border bg-primary text-primary-contrast">
        <h1 class="m-0 text-xl font-semibold">{{ modoOperacion === 'alquiler' ? 'Punto de alquiler' : 'Punto de venta' }}</h1>
        <div class="flex gap-1 rounded-full bg-white/20 p-1">
            <button type="button" (click)="setModoOperacion('venta')" class="px-4 py-2 rounded-full text-sm font-medium transition-colors" [class.bg-white]="modoOperacion === 'venta'" [class.text-primary]="modoOperacion === 'venta'" [class.text-primary-contrast]="modoOperacion !== 'venta'">Venta</button>
            <button type="button" (click)="setModoOperacion('alquiler')" class="px-4 py-2 rounded-full text-sm font-medium transition-colors" [class.bg-white]="modoOperacion === 'alquiler'" [class.text-primary]="modoOperacion === 'alquiler'" [class.text-primary-contrast]="modoOperacion !== 'alquiler'">Alquiler</button>
        </div>
        @if (carrito().length > 0) {
            <span class="px-3 py-1 text-sm rounded-full bg-white/20">{{ carrito().length }} ítem(s)</span>
        }
    </header>

    <!-- 3 columnas: responsive (1 col móvil, 2 cols tablet, 3 cols desktop) -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 flex-1 min-h-0 px-1">
        <!-- Columna 1: Cliente, tipo pedido, delivery, observaciones, crear pedido -->
        <p-card [header]="modoOperacion === 'alquiler' ? 'Datos del alquiler' : 'Datos del pedido'" styleClass="flex flex-col gap-4 flex-1 min-h-0 overflow-hidden h-full" class="order-1">
                <div class="flex flex-col gap-4">
                    <div>
                        <label class="block font-semibold mb-2 text-color">Cliente</label>
                        <div class="flex gap-2 items-center">
                            <p-autocomplete
                                [(ngModel)]="selectedCliente"
                                [suggestions]="clientesSugeridos"
                                (completeMethod)="buscarClientes($event)"
                                optionLabel="razonSocial"
                                placeholder="Buscar por nombre, código o RUC (mín. 2 caracteres)"
                                styleClass="flex-1 w-full"
                                [dropdown]="false"
                                [showClear]="true"
                                [minLength]="2"
                            />
                            <p-button icon="pi pi-user-plus" [rounded]="true" severity="secondary" title="Nuevo cliente" (onClick)="abrirNuevoCliente()" />
                        </div>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2 text-color">Tipo de pedido</label>
                        <div class="flex gap-2">
                            <p-button
                                label="Delivery"
                                icon="pi pi-truck"
                                [outlined]="tipoPedido !== 'DELIVERY'"
                                [severity]="tipoPedido === 'DELIVERY' ? 'primary' : 'secondary'"
                                (onClick)="tipoPedido = 'DELIVERY'"
                                styleClass="flex-1 min-h-[44px]"
                            />
                            <p-button
                                label="Retiro"
                                icon="pi pi-store"
                                [outlined]="tipoPedido !== 'RETIRO'"
                                [severity]="tipoPedido === 'RETIRO' ? 'primary' : 'secondary'"
                                (onClick)="tipoPedido = 'RETIRO'"
                                styleClass="flex-1 min-h-[44px]"
                            />
                        </div>
                    </div>
                    @if (tipoPedido === 'DELIVERY') {
                        <div class="flex flex-col gap-2">
                            <label class="font-semibold text-color">Dirección de entrega</label>
                            <input pInputText [(ngModel)]="direccionEntrega" class="w-full" placeholder="Dirección" />
                            <label class="font-semibold text-color mt-2">Teléfono</label>
                            <input pInputText [(ngModel)]="telefonoContacto" class="w-full" placeholder="Teléfono de contacto" />
                        </div>
                    }
                    <div>
                        <label class="block font-semibold mb-2 text-color">Observaciones</label>
                        <input pInputText [(ngModel)]="observaciones" class="w-full" placeholder="Opcional" />
                    </div>
                    <p-button
                        [label]="modoOperacion === 'alquiler' ? 'Crear alquiler' : 'Crear pedido'"
                        icon="pi pi-check"
                        iconPos="right"
                        [disabled]="carrito().length === 0 || !clienteId"
                        [pTooltip]="modoOperacion === 'alquiler' ? 'Próximamente: se implementará en el backend' : ''"
                        (onClick)="crearPedido()"
                        styleClass="w-full mt-auto min-h-[48px] text-lg font-semibold"
                    />
                </div>
        </p-card>

        <!-- Columna 2: Pedido actual (productos, cantidades, descuentos) -->
        <p-card [header]="modoOperacion === 'alquiler' ? 'Alquiler actual' : 'Pedido actual'" styleClass="flex flex-col gap-3 flex-1 min-h-0 overflow-hidden h-full" class="order-2">
                @if (carrito().length === 0) {
                    <div class="flex flex-col flex-1 items-center justify-center gap-3 py-8 text-muted-color">
                        <i class="pi pi-shopping-cart text-5xl opacity-50"></i>
                        <p class="m-0 font-medium text-color">Este pedido está vacío</p>
                        <span class="text-sm">Agregá productos desde el catálogo</span>
                    </div>
                } @else {
                    <div class="flex flex-col flex-1 min-h-0 overflow-hidden">
                        <!-- Líneas: primero nombre del producto, debajo los detalles -->
                        <div class="flex-1 min-h-0 overflow-y-auto overflow-x-hidden flex flex-col gap-3 py-2 max-h-[22rem]">
                            @for (linea of carrito(); track linea.producto.id) {
                                <div
                                    class="rounded-border bg-surface-100 p-3 cursor-pointer transition-shadow hover:bg-surface-200"
                                    [class.ring-2]="lineaSeleccionada === linea"
                                    [class.ring-primary]="lineaSeleccionada === linea"
                                    (click)="seleccionarLinea(linea)"
                                >
                                    <!-- 1) Nombre del producto (prioridad, visible completo) -->
                                    <div class="font-medium text-color text-sm mb-2 break-words line-clamp-2" [title]="linea.producto.nombre">
                                        {{ linea.producto.nombre }}
                                    </div>
                                    <!-- 2) Detalles: cant/días, p.unit, total, acciones -->
                                    <div class="flex flex-wrap items-center justify-between gap-3 text-sm">
                                        @if (modoOperacion === 'alquiler') {
                                            <div class="pdv-linea-alquiler flex flex-col gap-2 w-full min-w-0">
                                                <div class="flex items-center gap-2 flex-wrap">
                                                    <span class="text-muted-color shrink-0">Días</span>
                                                    <p-inputnumber [ngModel]="linea.dias ?? 1" [min]="1" [max]="365" [showButtons]="true" (ngModelChange)="cambiarDiasLinea(linea, $event)" (click)="$event.stopPropagation()" styleClass="pdv-dias-input" />
                                                    <span class="text-muted-color shrink-0">× {{ linea.precioUnitario | number:'1.2-2' }} /día</span>
                                                </div>
                                                <div class="flex flex-wrap items-center gap-3 gap-y-2">
                                                    <span class="text-muted-color shrink-0">Base (monto config. alquiler): <strong class="text-color">{{ getMontoBaseLinea(linea) | number:'1.2-2' }}</strong></span>
                                                    <label class="flex items-center gap-2 min-w-0 flex-1 text-muted-color" style="min-width: 10rem;">
                                                        <span class="shrink-0">Monto final:</span>
                                                        <p-inputnumber [(ngModel)]="linea.montoFinal" [min]="0" [minFractionDigits]="0" [maxFractionDigits]="2" [useGrouping]="false" (ngModelChange)="cambiarMontoFinalLinea(linea, $event)" (click)="$event.stopPropagation()" styleClass="pdv-monto-final-input" />
                                                    </label>
                                                    <span class="shrink-0 font-bold text-primary">{{ getTotalEfectivoLinea(linea) | number:'1.2-2' }}</span>
                                                    <span class="flex gap-1 shrink-0">
                                                        <p-button icon="pi pi-minus" [rounded]="true" [text]="true" size="small" (click)="restarCantidad(linea); $event.stopPropagation()" title="Menos días" />
                                                        <p-button icon="pi pi-plus" [rounded]="true" [text]="true" size="small" (click)="agregarCantidad(linea); $event.stopPropagation()" title="Más días" />
                                                        <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [text]="true" size="small" (click)="quitarDelCarrito(linea); $event.stopPropagation()" title="Quitar" />
                                                    </span>
                                                </div>
                                            </div>
                                        } @else {
                                            <span class="text-muted-color"><span class="font-semibold text-color">{{ linea.cantidad }}</span> × {{ linea.precioUnitario | number:'1.2-2' }}</span>
                                            <span class="font-bold text-primary">{{ getTotalEfectivoLinea(linea) | number:'1.2-2' }}</span>
                                            <span class="flex gap-1 shrink-0">
                                                <p-button icon="pi pi-minus" [rounded]="true" [text]="true" size="small" (click)="restarCantidad(linea); $event.stopPropagation()" title="Menos" />
                                                <p-button icon="pi pi-plus" [rounded]="true" [text]="true" size="small" (click)="agregarCantidad(linea); $event.stopPropagation()" title="Más" />
                                                <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [text]="true" size="small" (click)="quitarDelCarrito(linea); $event.stopPropagation()" title="Quitar" />
                                            </span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                        <!-- Resumen -->
                        <div class="flex flex-col gap-2 pt-4 mt-4 border-t border-surface-200">
                            <div class="flex justify-between text-sm text-muted-color">
                                <span>Subtotal</span>
                                <span>{{ totalCarrito() | number:'1.2-2' }}</span>
                            </div>
                            <div class="pdv-descuento-general flex flex-wrap items-center gap-3">
                                <label class="text-sm font-medium text-color shrink-0">Descuento % (general)</label>
                                <p-inputnumber [(ngModel)]="descuentoPorcentaje" [min]="0" [max]="100" [minFractionDigits]="0" [maxFractionDigits]="1" mode="decimal" [showButtons]="true" styleClass="pdv-descuento-input" />
                                @if (descuentoPorcentaje > 0) {
                                    <span class="text-sm text-orange-500 shrink-0">-{{ descuentoTotal() | number:'1.2-2' }}</span>
                                }
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t border-surface-200 text-base font-bold text-color">
                                <span>Total</span>
                                <span class="text-primary">{{ totalConDescuento() | number:'1.2-2' }}</span>
                            </div>
                        </div>
                    </div>
                }
        </p-card>

        <!-- Columna 3: Catálogo (ancho completo en tablet) -->
        <p-card header="Productos" styleClass="flex flex-col gap-3 flex-1 min-h-0 overflow-hidden h-full md:col-span-2 xl:col-span-1" class="order-3">
                <div class="flex flex-col gap-3 flex-1 min-h-0 overflow-hidden">
                    <p-iconfield iconPosition="left" styleClass="w-full">
                        <p-inputicon styleClass="pi pi-search" />
                        <input
                            pInputText
                            type="search"
                            [ngModel]="filtroProducto()"
                            (ngModelChange)="filtroProducto.set($event)"
                            placeholder="Buscar productos..."
                            class="w-full"
                        />
                    </p-iconfield>
                    <div class="flex flex-wrap gap-2">
                        <p-button
                            label="Todos"
                            [outlined]="categoriaIdSeleccionada() !== null"
                            [severity]="categoriaIdSeleccionada() === null ? 'primary' : 'secondary'"
                            size="small"
                            (onClick)="categoriaIdSeleccionada.set(null)"
                        />
                        @for (cat of categoriasConProductos(); track cat.id) {
                            <p-button
                                [label]="cat.nombre ?? cat.codigo ?? ''"
                                [outlined]="categoriaIdSeleccionada() !== cat.id"
                                [severity]="categoriaIdSeleccionada() === cat.id ? 'primary' : 'secondary'"
                                size="small"
                                (onClick)="categoriaIdSeleccionada.set(cat.id)"
                            />
                        }
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-3 gap-3 flex-1 min-h-0 overflow-y-auto content-start">
                        @for (p of productosVisibles(); track p.id) {
                            <button
                                type="button"
                                (click)="onProductoClick(p)"
                                class="flex flex-col items-center justify-start p-4 min-h-[140px] rounded-border border border-surface-200 bg-surface-50 text-center transition-all hover:border-primary hover:bg-primary-50 hover:shadow-md focus:outline-none focus-visible:ring-2 focus-visible:ring-primary"
                            >
                                <div class="w-16 h-16 rounded-border bg-surface-200 flex items-center justify-center mb-2">
                                    <i class="pi pi-box text-2xl text-muted-color"></i>
                                </div>
                                <span class="font-medium text-color text-sm line-clamp-2 mb-1">{{ p.nombre }}</span>
                                <span class="font-bold text-primary">{{ (modoOperacion === 'alquiler' ? (p.precioAlquilerDia ?? 0) : (p.precioVenta ?? 0)) | number:'1.2-2' }}</span>
                                @if (modoOperacion === 'alquiler') {
                                    <span class="text-xs text-muted-color">/ día</span>
                                }
                            </button>
                        }
                    </div>
                    @if (productosVisibles().length === 0) {
                        <p class="py-8 text-center text-muted-color">No hay productos o no coinciden con la búsqueda.</p>
                    }
                </div>
        </p-card>
    </div>
</div>

<!-- Diálogo nuevo cliente -->
<p-dialog
    [(visible)]="dialogNuevoCliente"
    header="Nuevo cliente"
    [style]="{ width: 'min(440px, 100vw - 2rem)' }"
    [contentStyle]="{ overflow: 'visible' }"
    [modal]="true"
    [closable]="true"
    (onHide)="cerrarDialogCliente()"
>
    <div class="flex flex-col gap-4">
        <div>
            <label for="pdv-razon" class="block font-semibold mb-2 text-color">Razón social o nombre <span class="text-red-500">*</span></label>
            <input id="pdv-razon" pInputText [(ngModel)]="nuevoCliente.razonSocial" class="w-full" placeholder="Ej. Juan Pérez o Empresa S.A." />
            @if (submittedCliente && !nuevoCliente.razonSocial?.trim()) {
                <span class="text-sm text-red-500">Requerido.</span>
            }
        </div>
        <div>
            <label for="pdv-ruc" class="block font-semibold mb-2 text-color">RUC</label>
            <input id="pdv-ruc" pInputText [(ngModel)]="nuevoCliente.ruc" class="w-full" placeholder="Sin guiones" />
        </div>
        <div>
            <label for="pdv-telefono" class="block font-semibold mb-2 text-color">Teléfono</label>
            <input id="pdv-telefono" pInputText [(ngModel)]="nuevoCliente.telefono" class="w-full" placeholder="Ej. 021 123 456" />
        </div>
        <div>
            <label for="pdv-celular" class="block font-semibold mb-2 text-color">Celular</label>
            <input id="pdv-celular" pInputText [(ngModel)]="nuevoCliente.celular" class="w-full" placeholder="Ej. 0981 123 456" />
        </div>
        <div>
            <label for="pdv-direccion" class="block font-semibold mb-2 text-color">Dirección</label>
            <input id="pdv-direccion" pInputText [(ngModel)]="nuevoCliente.direccion" class="w-full" placeholder="Para envíos o facturación" />
        </div>
    </div>
    <ng-template #footer>
        <p-button label="Cancelar" icon="pi pi-times" [text]="true" (click)="cerrarDialogCliente()" />
        <p-button label="Guardar cliente" icon="pi pi-check" (click)="guardarNuevoCliente()" [loading]="guardandoCliente()" />
    </ng-template>
</p-dialog>
