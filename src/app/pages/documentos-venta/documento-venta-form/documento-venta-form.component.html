<p-toast />
<div class="form-doc-venta">
    <header class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
            <p-button icon="pi pi-arrow-left" [rounded]="true" [text]="true" (onClick)="cancelar()" />
            <h2 class="m-0">{{ isEdit ? 'Editar documento' : 'Nuevo documento de venta' }}</h2>
        </div>
        <div class="flex gap-2">
            <p-button label="Cancelar" severity="secondary" [outlined]="true" (onClick)="cancelar()" />
            <p-button label="Guardar" icon="pi pi-check" [loading]="saving()" (onClick)="guardar()" />
        </div>
    </header>

    @if (loading()) {
        <p-card><div class="flex align-items-center gap-2"><i class="pi pi-spin pi-spinner"></i> Cargando...</div></p-card>
    } @else {
        <div class="grid grid-cols-12 gap-4">
            <!-- Bloque cliente -->
            <p-card class="col-span-12 md:col-span-6">
                <ng-template #title>Cliente</ng-template>
                <ng-template #subtitle>Requerido. Podés buscar o crear uno nuevo.</ng-template>
                <div class="flex gap-2 flex-wrap align-items-end">
                    <div class="flex-1 min-w-0">
                        <label class="block font-semibold mb-1">Cliente *</label>
                        <p-autocomplete
                            [(ngModel)]="selectedCliente"
                            [suggestions]="clientesSugeridos"
                            (completeMethod)="buscarClientes($event)"
                            (onSelect)="onClienteSelect()"
                            (onClear)="doc.cliente = undefined"
                            optionLabel="razonSocial"
                            placeholder="Buscar por nombre o RUC (mín. 2 caracteres)"
                            styleClass="w-full"
                            [dropdown]="false"
                            [showClear]="true"
                            [minLength]="2"
                            appendTo="body"
                        />
                    </div>
                    <p-button label="Nuevo cliente" icon="pi pi-user-plus" [outlined]="true" (onClick)="openNuevoCliente()" />
                </div>
            </p-card>

            <!-- Datos del documento -->
            <p-card class="col-span-12 md:col-span-6">
                <ng-template #title>Datos del documento</ng-template>
                <div class="grid grid-cols-12 gap-3">
                    <div class="col-span-12 sm:col-span-6">
                        <label class="block font-semibold mb-1">Empresa</label>
                        <p-select [(ngModel)]="doc.empresa" [options]="empresas" optionLabel="razonSocial" placeholder="Seleccione" styleClass="w-full" appendTo="body"
                            (onChange)="doc.empresa = $event.value ? { id: $event.value.id } : undefined" />
                    </div>
                    <div class="col-span-12 sm:col-span-6">
                        <label class="block font-semibold mb-1">Tipo documento</label>
                        <p-select [(ngModel)]="doc.tipoDocumento" [options]="tiposDocumento" optionLabel="nombre" placeholder="Seleccione" styleClass="w-full" appendTo="body" />
                    </div>
                    <div class="col-span-4">
                        <label class="block font-semibold mb-1">Estab.</label>
                        <input pInputText [(ngModel)]="doc.establecimiento" class="w-full" />
                    </div>
                    <div class="col-span-4">
                        <label class="block font-semibold mb-1">Pto. emisión</label>
                        <input pInputText [(ngModel)]="doc.puntoEmision" class="w-full" />
                    </div>
                    <div class="col-span-4">
                        <label class="block font-semibold mb-1">Número</label>
                        <input pInputText [(ngModel)]="doc.numero" class="w-full" />
                    </div>
                    <div class="col-span-6">
                        <label class="block font-semibold mb-1">Moneda</label>
                        <p-select [(ngModel)]="doc.moneda" [options]="monedas" optionLabel="codigo" placeholder="Moneda" styleClass="w-full" appendTo="body" />
                    </div>
                    <div class="col-span-6">
                        <label class="block font-semibold mb-1">Fecha emisión</label>
                        <input pInputText type="date" [(ngModel)]="doc.fechaEmision" class="w-full" />
                    </div>
                    <div class="col-span-12">
                        <label class="block font-semibold mb-1">Condición de pago</label>
                        <p-select [(ngModel)]="doc.condicionPago" [options]="condicionesPago" optionLabel="nombre" placeholder="Seleccione" styleClass="w-full" appendTo="body"
                            (onChange)="doc.condicionPago = $event.value ? { id: $event.value.id } : undefined" />
                    </div>
                </div>
            </p-card>

            <!-- Detalle -->
            <p-card class="col-span-12">
                <ng-template #title>Detalle</ng-template>
                <ng-template #subtitle>Agregá productos. Podés crear uno nuevo si no existe.</ng-template>
                <p-table [value]="doc.detalle ?? []" [tableStyle]="{ 'min-width': '40rem' }" dataKey="nroLinea">
                    <ng-template #header>
                        <tr>
                            <th>Producto</th>
                            <th style="width:8rem">Cantidad</th>
                            <th style="width:10rem">P. unit. (IVA incl.)</th>
                            <th style="width:6rem">Desc.%</th>
                            <th style="width:10rem">Total</th>
                            <th style="width:4rem"></th>
                        </tr>
                    </ng-template>
                    <ng-template #body let-line>
                        <tr>
                            <td>
                                <div class="flex gap-1 align-items-center">
                                    <p-autocomplete
                                        [ngModel]="getProductoForLine(line)"
                                        (ngModelChange)="onProductoSelect(line, $event)"
                                        [suggestions]="productosSugeridos"
                                        (completeMethod)="buscarProductos($event)"
                                        optionLabel="nombre"
                                        placeholder="Buscar producto (mín. 2 caracteres)"
                                        styleClass="flex-1 min-w-0"
                                        [dropdown]="false"
                                        [showClear]="true"
                                        [minLength]="2"
                                        appendTo="body"
                                    />
                                </div>
                            </td>
                            <td><p-inputnumber [(ngModel)]="line.cantidad" (ngModelChange)="recalcLine(line)" [min]="0.0001" styleClass="w-full" /></td>
                            <td><p-inputnumber [(ngModel)]="line.precioUnitario" (ngModelChange)="recalcLine(line)" mode="decimal" [minFractionDigits]="0" [maxFractionDigits]="0" [useGrouping]="true" styleClass="w-full" /></td>
                            <td><p-inputnumber [(ngModel)]="line.descuento" (ngModelChange)="recalcLine(line)" [min]="0" [max]="100" styleClass="w-full" /></td>
                            <td>{{ line.totalLinea | number:'1.0-0' }} Gs.</td>
                            <td><p-button icon="pi pi-trash" severity="danger" [rounded]="true" [text]="true" (onClick)="removeLine(line)" /></td>
                        </tr>
                    </ng-template>
                    <ng-template #emptymessage>
                        <tr><td colspan="6">Sin líneas. Usá el botón de abajo para agregar.</td></tr>
                    </ng-template>
                </p-table>
                <div class="flex gap-2 mt-2 flex-wrap">
                    <p-button label="Agregar línea" icon="pi pi-plus" [rounded]="true" [outlined]="true" (onClick)="addLine()" />
                    <p-button label="Nuevo producto" icon="pi pi-box" [rounded]="true" [outlined]="true" (onClick)="openNuevoProducto()" />
                </div>
                <div class="flex justify-end gap-3 mt-3 text-lg">
                    <span class="font-semibold">Subtotal:</span><span>{{ doc.subtotal | number:'1.0-0' }} Gs.</span>
                    <span class="font-semibold">IVA:</span><span>{{ doc.totalIva | number:'1.0-0' }} Gs.</span>
                    <span class="font-semibold">Total:</span><span>{{ doc.total | number:'1.0-0' }} Gs.</span>
                </div>
            </p-card>
        </div>
    }
</div>

<!-- Diálogo nuevo cliente -->
<p-dialog [(visible)]="dialogNuevoCliente" header="Nuevo cliente" [modal]="true" [style]="{ width: '28rem' }" (onHide)="dialogNuevoCliente = false">
    <div class="flex flex-col gap-3">
        <div>
            <label class="block font-semibold mb-1">Razón social *</label>
            <input pInputText [(ngModel)]="nuevoCliente.razonSocial" class="w-full" placeholder="Nombre o razón social" />
        </div>
        <div>
            <label class="block font-semibold mb-1">RUC</label>
            <input pInputText [(ngModel)]="nuevoCliente.ruc" class="w-full" placeholder="Opcional" />
        </div>
    </div>
    <ng-template #footer>
        <p-button label="Cancelar" severity="secondary" [text]="true" (onClick)="dialogNuevoCliente = false" />
        <p-button label="Crear" icon="pi pi-check" [loading]="guardandoCliente" (onClick)="guardarNuevoCliente()" />
    </ng-template>
</p-dialog>

<!-- Diálogo nuevo producto -->
<p-dialog [(visible)]="dialogNuevoProducto" header="Nuevo producto" [modal]="true" [style]="{ width: '28rem' }" (onHide)="dialogNuevoProducto = false">
    <div class="flex flex-col gap-3">
        <div>
            <label class="block font-semibold mb-1">Nombre *</label>
            <input pInputText [(ngModel)]="nuevoProducto.nombre" class="w-full" placeholder="Nombre del producto" />
        </div>
        <div>
            <label class="block font-semibold mb-1">Precio de venta</label>
            <p-inputnumber [(ngModel)]="nuevoProducto.precioVenta" mode="decimal" prefix="Gs. " [minFractionDigits]="0" [maxFractionDigits]="0" [useGrouping]="true" styleClass="w-full" />
        </div>
        <div>
            <label class="block font-semibold mb-1">Unidad de medida *</label>
            <p-select [(ngModel)]="nuevoProducto.unidadMedida" [options]="unidadesMedida" optionLabel="nombre" placeholder="Seleccione" styleClass="w-full" appendTo="body" />
        </div>
        <div>
            <label class="block font-semibold mb-1">IVA %</label>
            <p-inputnumber [(ngModel)]="nuevoProducto.ivaPorcentaje" [min]="0" [max]="100" styleClass="w-full" />
        </div>
    </div>
    <ng-template #footer>
        <p-button label="Cancelar" severity="secondary" [text]="true" (onClick)="dialogNuevoProducto = false" />
        <p-button label="Crear" icon="pi pi-check" [loading]="guardandoProducto" (onClick)="guardarNuevoProducto()" />
    </ng-template>
</p-dialog>
