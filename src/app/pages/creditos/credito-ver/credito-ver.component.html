<div class="credito-ver-page max-w-6xl mx-auto w-full px-2 md:px-4">
    <header class="mb-4">
        <div class="flex align-items-center gap-3 flex-wrap">
            <p-button icon="pi pi-arrow-left" [rounded]="true" [text]="true" (onClick)="volver()" aria-label="Volver" />
            <h1 class="m-0 text-3xl font-bold">Crédito #{{ credito()?.id }}</h1>
            @if (credito()?.estado) {
                <p-tag [value]="credito()?.estado ?? ''" [severity]="getEstadoSeverity(credito()?.estado)" styleClass="text-sm px-3 py-1" />
            }
        </div>
    </header>

    @if (loading()) {
        <div class="flex align-items-center gap-2 py-6 text-color-secondary">
            <i class="pi pi-spin pi-spinner"></i>
            <span>Cargando...</span>
        </div>
    } @else if (credito()) {
        <p-card header="Datos del crédito" styleClass="mb-4">
            <div class="flex flex-wrap gap-2">
                <div class="flex-1 min-w-40">
                    <div class="surface-100 border-round p-3 h-full">
                        <span class="block text-color-secondary text-sm font-medium mb-1">Cliente</span>
                        <span class="font-semibold text-lg">{{ clienteNombre() }}</span>
                    </div>
                </div>
                <div class="flex-1 min-w-40">
                    <div class="surface-100 border-round p-3 h-full">
                        <span class="block text-color-secondary text-sm font-medium mb-1">Monto total</span>
                        <span class="font-semibold text-xl text-primary">{{ credito()?.montoTotal | number:'1.2-2' }} Gs.</span>
                    </div>
                </div>
                <div class="flex-1 min-w-40">
                    <div class="surface-100 border-round p-3 h-full">
                        <span class="block text-color-secondary text-sm font-medium mb-1">Estado</span>
                        <p-tag [value]="credito()?.estado ?? '-'" [severity]="getEstadoSeverity(credito()?.estado)" />
                    </div>
                </div>
                <div class="flex-1 min-w-40">
                    <div class="surface-100 border-round p-3 h-full">
                        <span class="block text-color-secondary text-sm font-medium mb-1">Sistema</span>
                        <span class="font-semibold">{{ getSistemaLabel(credito()?.sistemaAmort) }}</span>
                    </div>
                </div>
                <div class="flex-1 min-w-40">
                    <div class="surface-100 border-round p-3 h-full">
                        <span class="block text-color-secondary text-sm font-medium mb-1">Nº cuotas</span>
                        <span class="font-semibold text-xl">{{ credito()?.nroCuotas }}</span>
                    </div>
                </div>
                <div class="flex-1 min-w-40">
                    <div class="surface-100 border-round p-3 h-full">
                        <span class="block text-color-secondary text-sm font-medium mb-1">Tasa % anual</span>
                        <span class="font-semibold">{{ credito()?.tasaInteresAnual ?? 0 | number:'1.2-2' }}</span>
                    </div>
                </div>
                <div class="flex-1 min-w-40">
                    <div class="surface-100 border-round p-3 h-full">
                        <span class="block text-color-secondary text-sm font-medium mb-1">Tasa mora % / días gracia</span>
                        <span class="font-semibold">{{ credito()?.tasaMoraAnual != null ? (credito()?.tasaMoraAnual | number:'1.2-2') : '—' }} / {{ credito()?.diasGracia ?? 0 }}</span>
                    </div>
                </div>
                <div class="flex-1 min-w-40">
                    <div class="surface-100 border-round p-3 h-full">
                        <span class="block text-color-secondary text-sm font-medium mb-1">Fecha inicio</span>
                        <span class="font-semibold">{{ credito()?.fechaInicio ? (credito()?.fechaInicio | date:'dd/MM/yyyy HH:mm:ss') : '-' }}</span>
                    </div>
                </div>
                <div class="flex-1 min-w-40">
                    <div class="surface-100 border-round p-3 h-full">
                        <span class="block text-color-secondary text-sm font-medium mb-1">Fecha siguiente venc.</span>
                        <span class="font-semibold">{{ credito()?.fechaPrimerVencimiento ? (credito()?.fechaPrimerVencimiento | date:'dd/MM/yyyy HH:mm:ss') : '-' }}</span>
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap gap-2 mt-3 pt-3 border-t border-surface-200">
            @if (puedePagarOCancelar()) {
                <p-button icon="pi pi-wallet" label="Pagar cuota" severity="secondary" (onClick)="openPagarCuota()" />
                <p-button icon="pi pi-times-circle" label="Cancelar crédito" severity="warn" [outlined]="true" (onClick)="openCancelarCredito()" />
            }
            <p-button icon="pi pi-refresh" label="Recalcular estado de cuotas" [outlined]="true" severity="secondary" (onClick)="recalcularCuotas()" title="Corrige cuotas en PARCIAL cuando se pagó el monto completo" />
        </div>
        </p-card>

        <p-card header="Cálculo de cuotas">
            @let resumen = getResumenCuotas();
            <div class="flex flex-wrap gap-2 mb-4">
                <div class="flex-1 min-w-40">
                    <div class="surface-100 border-round p-3 h-full">
                        <span class="block text-color-secondary text-sm font-medium mb-1">Total cuotas</span>
                        <span class="font-semibold text-xl">{{ resumen.total }}</span>
                    </div>
                </div>
                <div class="flex-1 min-w-40">
                    <div class="surface-100 border-round p-3 h-full">
                        <span class="block text-color-secondary text-sm font-medium mb-1">Pagadas</span>
                        <span class="font-semibold text-xl text-green-600">{{ resumen.pagadas }}</span>
                    </div>
                </div>
                <div class="flex-1 min-w-40">
                    <div class="surface-100 border-round p-3 h-full">
                        <span class="block text-color-secondary text-sm font-medium mb-1">Pendientes</span>
                        <span class="font-semibold text-xl text-orange-600">{{ resumen.pendientes }}</span>
                    </div>
                </div>
                <div class="flex-1 min-w-40">
                    <div class="surface-100 border-round p-3 h-full">
                        <span class="block text-color-secondary text-sm font-medium mb-1">Suma cuotas</span>
                        <span class="font-semibold text-xl">{{ resumen.montoTotalCuotas | number:'1.2-2' }} Gs.</span>
                    </div>
                </div>
            </div>
            <p-table
                [value]="getCuotas()"
                [tableStyle]="{ 'min-width': '40rem' }"
                styleClass="p-datatable-sm p-datatable-striped"
                [paginator]="getCuotas().length > 10"
                [rows]="10"
                [rowsPerPageOptions]="[10, 25, 50]"
                currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} cuotas"
            >
                <ng-template #header>
                    <tr>
                        <th style="width:3.5rem">Nº</th>
                        <th style="min-width:6rem">Vencimiento</th>
                        <th class="text-right" style="min-width:8rem">Capital</th>
                        <th class="text-right" style="min-width:6rem">Interés</th>
                        <th class="text-right" style="min-width:8rem">Monto cuota</th>
                        <th class="text-right" style="min-width:8rem" title="Si pagas hoy: capital + interés proporcional (sin interés completo)">Si pagas hoy</th>
                        <th class="text-right" style="min-width:8rem">Saldo insoluto</th>
                        <th style="min-width:6rem">Estado</th>
                    </tr>
                </ng-template>
                <ng-template #body let-c>
                    <tr>
                        <td>{{ c.nroCuota }}</td>
                        <td>{{ c.fechaVencimiento | date:'dd/MM/yyyy HH:mm:ss' }}</td>
                        <td class="text-right">{{ c.montoCapital | number:'1.2-2' }} Gs.</td>
                        <td class="text-right">{{ c.montoInteres | number:'1.2-2' }} Gs.</td>
                        <td class="text-right font-semibold">{{ c.montoCuota | number:'1.2-2' }} Gs.</td>
                        <td class="text-right">
                            @if (getMontoPagarHoy(c) != null) {
                                <span class="text-primary font-medium" title="Monto con interés proporcional al día de hoy">{{ getMontoPagarHoy(c) | number:'1.2-2' }} Gs.</span>
                            } @else {
                                <span class="text-color-secondary">—</span>
                            }
                        </td>
                        <td class="text-right">{{ c.saldoInsoluto | number:'1.2-2' }} Gs.</td>
                        <td>
                            <p-tag [value]="c.estado ?? '-'" [severity]="getCuotaEstadoSeverity(c.estado)" />
                        </td>
                    </tr>
                </ng-template>
                <ng-template #emptymessage>
                    <tr>
                        <td colspan="8" class="text-center py-6 text-color-secondary">
                            No hay cuotas cargadas.
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </p-card>
    }
</div>

<p-toast />
<p-dialog [(visible)]="dialogPagarCuota" [style]="{ width: '420px' }" header="Pagar cuota" [modal]="true" (onHide)="dialogPagarCuota = false">
    <ng-template #content>
        @if (getProximaCuota(); as cuota) {
            <p class="text-color-secondary mb-3">Cuota {{ cuota.nroCuota }} — Monto a pagar:</p>
            <div class="flex flex-col gap-3">
                <div>
                    <label class="block font-bold mb-2">Monto *</label>
                    <p-inputnumber [(ngModel)]="pagarCuotaMonto" mode="decimal" [minFractionDigits]="2" [min]="0" styleClass="w-full" />
                </div>
                <div>
                    <label class="block font-bold mb-2">Fecha de pago *</label>
                    <input pInputText type="date" [(ngModel)]="pagarCuotaFecha" (ngModelChange)="actualizarMontoPagarCuota(cuota.id)" class="w-full" />
                </div>
                <div>
                    <label class="block font-bold mb-2">Medio de pago</label>
                    <p-select [(ngModel)]="pagarCuotaMedioPagoId" [options]="mediosPago" optionLabel="nombre" optionValue="id" placeholder="Medio" styleClass="w-full" appendTo="body" (onChange)="pagarCuotaMedioPagoId = $event.value ?? null" />
                </div>
                <div>
                    <label class="block font-bold mb-2">Referencia</label>
                    <input pInputText [(ngModel)]="pagarCuotaReferencia" class="w-full" />
                </div>
            </div>
        }
    </ng-template>
    <ng-template #footer>
        <p-button label="Cerrar" icon="pi pi-times" text (onClick)="dialogPagarCuota = false" />
        <p-button label="Registrar pago" icon="pi pi-check" (onClick)="confirmarPagarCuota()" />
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="dialogCancelar" [style]="{ width: '440px' }" header="Cancelar crédito" [modal]="true" (onHide)="dialogCancelar = false">
    <ng-template #content>
        <p class="text-color-secondary mb-3">Se registrará el pago del capital pendiente y se darán de baja las cuotas pendientes.</p>
        <div class="surface-100 border-round p-3 mb-3">
            <label class="block text-sm font-medium text-color-secondary mb-1">Monto a pagar (capital pendiente)</label>
            <span class="text-xl font-bold">{{ cancelacionMontoTotal | number:'1.2-2' }} Gs.</span>
        </div>
        <div class="flex flex-col gap-3">
            <div>
                <label class="block font-bold mb-2">Fecha de pago *</label>
                <input pInputText type="date" [(ngModel)]="cancelarFecha" class="w-full" />
            </div>
            <div>
                <label class="block font-bold mb-2">Medio de pago</label>
                <p-select [(ngModel)]="cancelarMedioPagoId" [options]="mediosPago" optionLabel="nombre" optionValue="id" placeholder="Medio" styleClass="w-full" appendTo="body" (onChange)="cancelarMedioPagoId = $event.value ?? null" />
            </div>
            <div>
                <label class="block font-bold mb-2">Referencia</label>
                <input pInputText [(ngModel)]="cancelarReferencia" class="w-full" />
            </div>
            <div>
                <label class="block font-bold mb-2">Observaciones</label>
                <input pInputText [(ngModel)]="cancelarObservaciones" class="w-full" />
            </div>
        </div>
    </ng-template>
    <ng-template #footer>
        <p-button label="Cerrar" icon="pi pi-times" text (onClick)="dialogCancelar = false" />
        <p-button label="Confirmar cancelación" icon="pi pi-check" severity="danger" (onClick)="confirmarCancelarCredito()" />
    </ng-template>
</p-dialog>
