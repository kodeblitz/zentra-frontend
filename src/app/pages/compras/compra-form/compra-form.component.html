<p-toast />
<div class="flex flex-col flex-1 min-h-0">
    <header class="flex flex-wrap items-center gap-4 p-4 mb-4 rounded-border bg-primary text-primary-contrast shadow-sm">
        <button type="button" (click)="cancelar()" class="p-2 rounded-full hover:bg-white/20" aria-label="Volver">
            <i class="pi pi-arrow-left"></i>
        </button>
        <h1 class="m-0 text-xl font-semibold">{{ isEdit ? 'Editar compra' : 'Nueva compra' }}</h1>
    </header>

    <div class="flex flex-col gap-6 px-4 max-w-4xl mx-auto w-full pb-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block font-semibold mb-2">Proveedor *</label>
                <p-select
                    [(ngModel)]="compra.proveedor"
                    [options]="proveedores"
                    optionLabel="razonSocial"
                    placeholder="Seleccionar proveedor"
                    styleClass="w-full"
                    appendTo="body"
                />
            </div>
            <div>
                <label class="block font-semibold mb-2">Fecha compra</label>
                <input pInputText type="date" [(ngModel)]="compra.fechaCompra" class="w-full" />
            </div>
            <div>
                <label class="block font-semibold mb-2">Moneda</label>
                <p-select
                    [(ngModel)]="compra.moneda"
                    [options]="monedas"
                    optionLabel="nombre"
                    placeholder="Seleccionar"
                    styleClass="w-full"
                    appendTo="body"
                />
            </div>
            @if (monedaNoEsGuaranies()) {
                <div>
                    <label class="block font-semibold mb-2">Cotización (1 {{ simboloMoneda() }} = X Gs.)</label>
                    <p-inputnumber
                        [(ngModel)]="compra.cotizacion"
                        [min]="0.000001"
                        [minFractionDigits]="2"
                        [maxFractionDigits]="6"
                        mode="decimal"
                        placeholder="Ej: 7500"
                        styleClass="w-full"
                    />
                    <small class="text-muted-color text-xs block mt-1">Registro histórico para precios de compra.</small>
                </div>
            }
        </div>
        <div>
            <label class="block font-semibold mb-2">Observaciones</label>
            <input pInputText [(ngModel)]="compra.observaciones" class="w-full" />
        </div>

        <div>
            <div class="flex justify-between items-center mb-2">
                <label class="font-semibold">Detalle</label>
                <div class="flex gap-2">
                    <p-button label="Agregar línea" icon="pi pi-plus" [outlined]="true" (onClick)="agregarLinea()" />
                    <p-button label="Nuevo producto" icon="pi pi-box" [outlined]="true" (onClick)="openNuevoProducto()" />
                </div>
            </div>
            <p-table [value]="compra.detalle ?? []" [tableStyle]="{ 'min-width': '40rem' }" styleClass="p-datatable-sm">
                <ng-template #header>
                    <tr>
                        <th style="min-width:14rem">Producto</th>
                        <th style="min-width:6rem">Cantidad</th>
                        <th style="min-width:8rem">P. unit. ({{ simboloMoneda() }})</th>
                        <th style="width:4rem"></th>
                    </tr>
                </ng-template>
                <ng-template #body let-line let-i="rowIndex">
                    <tr>
                        <td>
                            <p-autocomplete
                                [ngModel]="getProductoForLine(line)"
                                (ngModelChange)="onProductoSelect(line, $event)"
                                [suggestions]="productosSugeridos"
                                (completeMethod)="buscarProductos($event)"
                                optionLabel="nombre"
                                placeholder="Buscar producto (mín. 2 caracteres)"
                                styleClass="w-full"
                                [dropdown]="false"
                                [showClear]="true"
                                [minLength]="2"
                                appendTo="body"
                            />
                        </td>
                        <td>
                            <p-inputnumber [(ngModel)]="line.cantidad" [min]="0.01" mode="decimal" styleClass="w-full" />
                        </td>
                        <td>
                            <p-inputnumber [(ngModel)]="line.precioUnitario" [min]="0" mode="decimal" styleClass="w-full" />
                        </td>
                        <td>
                            <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [text]="true" (onClick)="quitarLinea(i)" />
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>

        <div class="flex gap-2">
            <p-button label="Guardar" icon="pi pi-check" (onClick)="guardar()" [loading]="saving()" />
            <p-button label="Cancelar" severity="secondary" [outlined]="true" (onClick)="cancelar()" />
        </div>
    </div>
</div>

<!-- Diálogo nuevo producto -->
<p-dialog [(visible)]="dialogNuevoProducto" header="Nuevo producto" [modal]="true" [style]="{ width: '28rem' }" (onHide)="dialogNuevoProducto = false">
    <div class="flex flex-col gap-3">
        <div>
            <label class="block font-semibold mb-1">Nombre *</label>
            <input pInputText [(ngModel)]="nuevoProducto.nombre" class="w-full" placeholder="Nombre del producto" />
        </div>
        <div>
            <label class="block font-semibold mb-1">Costo (Gs.)</label>
            <p-inputnumber [(ngModel)]="nuevoProducto.costo" mode="decimal" [minFractionDigits]="0" [maxFractionDigits]="0" [useGrouping]="true" styleClass="w-full" />
        </div>
        <div>
            <label class="block font-semibold mb-1">Unidad de medida *</label>
            <p-select [(ngModel)]="nuevoProducto.unidadMedida" [options]="unidadesMedida" optionLabel="nombre" placeholder="Seleccione" styleClass="w-full" appendTo="body" />
        </div>
        <div>
            <label class="block font-semibold mb-1">IVA %</label>
            <p-inputnumber [(ngModel)]="nuevoProducto.ivaPorcentaje" [min]="0" [max]="100" styleClass="w-full" />
        </div>
    </div>
    <ng-template #footer>
        <p-button label="Cancelar" severity="secondary" [text]="true" (onClick)="dialogNuevoProducto = false" />
        <p-button label="Crear" icon="pi pi-check" [loading]="guardandoProducto" (onClick)="guardarNuevoProducto()" />
    </ng-template>
</p-dialog>
